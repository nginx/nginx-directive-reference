name: Daily Reference Converter Run

on:
  schedule:
    - cron: '0 14 * * *'  # Run daily at 2pm UTC
  workflow_dispatch:

defaults:
  run:
    working-directory: ./tools/reference-converter
    shell: bash

jobs:
  compare_outputs:
    runs-on: ubuntu-latest
    env:
      converter-directory: ./tools/reference-converter

    steps:
    - uses: actions/checkout@v3
    # TODO: reuse the build steps
    - run: make devtools-image
    - name: let the build create files
      run: chmod 777 .
    - run: make build
    - name: run converter
      run: ./dist/reference-converter -dst ./output/reference.json

    - name: diff reference.json
      id: diff
      run: |
        if ! diff -q ../../docs/lib/reference.json ./output/reference.json; then
          echo "reference_change=true" >> "$GITHUB_OUTPUT"
          mv ./output/reference.json ../../docs/lib/reference.json
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
        fi

    - name: create pull request if reference.json changed
      uses: peter-evans/create-pull-request@v3
      if: steps.diff.outputs.reference_change
      with:
        commit-message: update reference.json
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: reference-update-${{ env.date }}
        title: "Reference Json Update"
        body: "Changes detected in reference.json"
        delete-branch: true
        add-paths: docs/lib/reference.json
