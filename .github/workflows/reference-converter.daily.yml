name: Daily Reference Converter Run

on:
  schedule:
    - cron: '0 10 * * *'  # Run daily at 10am
  workflow_dispatch:

jobs:
  compare_outputs:
    runs-on: ubuntu-latest
    env:
      converter-directory: ./tools/reference-converter

    steps:
    - uses: actions/checkout@v3
    # TODO: reuse the build steps
    - run: make devtools-image
    - name: let the build create files
      run: chmod 777 .
    - run: make build
    - name: run converter
      run: ${{ env.converter-directory }}/dist/reference-converter -dst ${{ env.converter-directory }}/output/reference.json

    - name: diff reference.json
      id: diff
      run: |
        if ! diff -q ./docs/lib/reference.json ${{ env.converter-directory }}/output/reference.json; then
          echo "reference_change=true" >> "$GITHUB_OUTPUT"
        fi

    - name: create pull request if reference.json changed
      uses: peter-evans/create-pull-request@v3
      if: steps.diff.outputs.reference_change
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: reference-update-$(date -u +\%Y\%m\%d)
        title: "Reference Json Update"
        body: "Changes detected in reference.json"
        delete-branch: true
        add-paths: docs/lib/reference.json
